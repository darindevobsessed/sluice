# Craft State Export (Pre-Compact)

This file was created automatically before context compaction.
Use this to restore state if needed.

## Global State
```bash
LAST_ACTIVITY="2026-02-06T15:45:35Z"
ACTIVE_CYCLE="rag-foundation"
CURRENT_STORY="3-embedding-pipeline"
DEFAULT_MODE="creative"
BACKLOG_COUNT=1
HARNESS_CHECKED="2026-02-03"
HARNESS_VERSION="1.0"
CRAFT_WRITE_ENABLED="true"
PLANNING_CYCLE="mcp-intelligence"
RUN_MODE="cruise"
```

## Cycle State: rag-foundation
```bash
CYCLE_NAME="rag-foundation"
CYCLE_STATUS="active"
CURRENT_STORY="3-embedding-pipeline"
CURRENT_CHUNK="4"
TOTAL_CHUNKS="4"
LAST_VALIDATION="2026-02-06T15:36:28Z"
LAST_CHECKPOINT="2026-02-06T15:45:35Z"
TOUCHED_FILES="/Users/darindrobinski/dev/repos/gold-miner/docker-compose.yml /Users/darindrobinski/dev/repos/gold-miner/.env.example /Users/darindrobinski/dev/repos/gold-miner/scripts/init-db.sql /Users/darindrobinski/dev/repos/gold-miner/.gitignore /Users/darindrobinski/dev/repos/gold-miner/README.md /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/__tests__/search.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/schema.ts /Users/darindrobinski/dev/repos/gold-miner/drizzle.config.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/index.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/search.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/route.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/insights.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/__tests__/insights.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/scripts/migrate-data.ts /Users/darindrobinski/dev/repos/gold-miner/package.json /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/__tests__/setup.ts /Users/darindrobinski/dev/repos/gold-miner/vitest.config.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/__tests__/rate-limit.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/youtube/__tests__/transcript.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/rate-limit.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/youtube/transcript.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/youtube/transcript/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/youtube/transcript/route.ts /Users/darindrobinski/dev/repos/gold-miner/src/components/add-video/__tests__/TranscriptInstructions.test.tsx /Users/darindrobinski/dev/repos/gold-miner/src/components/add-video/__tests__/TranscriptSection.test.tsx /Users/darindrobinski/dev/repos/gold-miner/src/components/add-video/__tests__/AddVideoPage.test.tsx /Users/darindrobinski/dev/repos/gold-miner/src/components/add-video/TranscriptInstructions.tsx /Users/darindrobinski/dev/repos/gold-miner/src/components/add-video/TranscriptSection.tsx /Users/darindrobinski/dev/repos/gold-miner/src/components/add-video/AddVideoPage.tsx /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/__tests__/pipeline.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/pipeline.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/index.ts /Users/darindrobinski/dev/repos/gold-miner/next.config.ts /Users/darindrobinski/dev/repos/gold-miner/scripts/test-embeddings.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/types.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/__tests__/chunker.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/chunker.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/__tests__/service.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/service.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/embeddings/__tests__/service.integration.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/hooks/__tests__/useEmbedding.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/components/video/__tests__/EmbedButton.test.tsx /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/route.ts /Users/darindrobinski/dev/repos/gold-miner/src/hooks/useEmbedding.ts /Users/darindrobinski/dev/repos/gold-miner/src/components/video/EmbedButton.tsx /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/embed/status/route.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/videos/[id]/page.tsx /Users/darindrobinski/dev/repos/gold-miner/src/app/videos/[id]/page.tsx"
```

## Current Story
File: .craft/cycles/rag-foundation/stories/3-embedding-pipeline.md

```markdown
---
name: embedding-pipeline
title: Embedding Pipeline
status: active
priority: high
created: 2026-02-05
updated: 2026-02-06
cycle: rag-foundation
story_number: 3
chunks_total: 4
chunks_complete: 3
---

# Story: Embedding Pipeline

## Spark

Set up Transformers.js (@huggingface/transformers) for local embedding generation — free, no API costs, runs on your machine. Convert transcript text into vector embeddings that capture semantic meaning.

Design a smart chunking strategy: break transcripts at semantic boundaries (topic shifts, ~500 tokens per chunk with overlap). Preserve timestamp metadata on each chunk for future temporal queries (Cycle 2).

Store embeddings in Postgres using PG Vector's vector type (384 dimensions for all-MiniLM-L6-v2).

> *"Instead of using OpenAI's embedding API, which means for every single transcript, you're gonna have to pay OpenAI to do the embeddings. You can use this really cool one called fast embed. Fast embed will run locally on your server and will create those embeddings for you."*

**Note:** We chose Transformers.js over FastEmbed because:
- FastEmbed-js repository was archived (Jan 2026)
- Transformers.js is backed by Hugging Face with active maintenance
- Better Vercel deployment compatibility with documented workarounds

## Dependencies

**Blocked by:** Story 1 (Database Migration) — needs PG Vector for storage
**Blocks:** Story 4 (RAG Search)

## Acceptance

- [ ] Transformers.js installed and configured with singleton pattern
- [ ] all-MiniLM-L6-v2 model generates 384-dimensional embeddings
- [ ] Transcripts are chunked at ~500 tokens with 100-char overlap
- [ ] Each chunk preserves start/end timestamps from transcript segments
- [ ] Embeddings stored in `chunks` table with pgvector
- [ ] Progress callbacks work during embedding generation
- [ ] API route generates embeddings for a video on demand
- [ ] UI shows embedding progress for long transcripts
- [ ] Batch processing handles 100+ chunks efficiently
- [ ] Re-embedding triggered when transcript updates

## Chunks

```

## Recent Checkpoints
```
2541abd checkpoint: before story 3, chunk 4
75937f5 checkpoint: before story 3, chunk 3
c019b76 checkpoint: before story 3, chunk 2
246f998 checkpoint: before story 3, chunk 1
c8f6428 checkpoint: before story 2, chunk 3
188edc3 checkpoint: before story 2, chunk 2
66ff65e checkpoint: before story 2, chunk 1
78caa82 checkpoint: before story 1, chunk 5
1efd087 checkpoint: before story 1, chunk 4
4ebc576 checkpoint: before story 1, chunk 2
```
