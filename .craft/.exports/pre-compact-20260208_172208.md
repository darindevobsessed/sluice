# Craft State Export (Pre-Compact)

This file was created automatically before context compaction.
Use this to restore state if needed.

## Global State
```bash
LAST_ACTIVITY="2026-02-08T23:13:24Z"
ACTIVE_CYCLE="polish"
CURRENT_STORY="1-extraction-persistence"
DEFAULT_MODE="creative"
BACKLOG_COUNT=1
HARNESS_CHECKED="2026-02-03"
HARNESS_VERSION="1.0"
CRAFT_WRITE_ENABLED="true"
PLANNING_CYCLE=""
RUN_MODE="cruise"
```

## Cycle State: Polish & Reliability
```bash
# Cycle State
# Runtime state for active implementation session
CYCLE_NAME="polish"
CYCLE_STATUS="active"
CURRENT_STORY="1-extraction-persistence"
CURRENT_CHUNK="2"
TOTAL_CHUNKS="4"
LAST_VALIDATION="2026-02-08T22:57:07Z"
LAST_CHECKPOINT="2026-02-08T23:13:24Z"
TOUCHED_FILES="/Users/darindrobinski/dev/repos/gold-miner/src/hooks/__tests__/useExtraction.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/hooks/useExtraction.ts /Users/darindrobinski/dev/repos/gold-miner/src/components/insights/InsightsTabs.tsx /Users/darindrobinski/dev/repos/gold-miner/src/components/providers/ExtractionProvider.tsx /Users/darindrobinski/dev/repos/gold-miner/src/hooks/__tests__/useExtraction.test.tsx"
```

## Current Story
File: .craft/cycles/polish/stories/1-extraction-persistence.md

```markdown
---
name: insights-extraction-persistence
title: Persist Insights Extraction Progress Across Navigation
status: active
cycle: polish
story_number: 1
created: 2026-02-08
updated: 2026-02-08
priority: high
chunks_total: 4
chunks_complete: 1
---

# Story: Persist Insights Extraction Progress Across Navigation

## Spark
When insights are extracting and the user navigates away then returns, there's no signal that extraction is running. All state lives in component-level useState inside useExtraction, so it's lost on unmount. A global ExtractionProvider context will hold extraction state in a Map<videoId, ExtractionState>, keeping WebSocket callbacks alive and progress visible across navigation.

## Scope

**Included:**
- New ExtractionProvider context wrapping the app
- Refactor useExtraction to read/write from global context instead of local state
- WebSocket callbacks update global store even when video page is unmounted
- Returning to a video page reconnects to live streaming progress
- Background completion triggers DB persistence automatically
- Cleanup: evict from store after successful DB write

**Excluded:**
- DB-backed partial persistence (no schema changes)
- localStorage/sessionStorage caching
- Progress surviving full page refresh or browser restart
- Global indicator in top bar showing active extractions (could be a follow-up)

## Preserve
- Existing extraction streaming UX (section-by-section, typing cursor)
- AgentConnection WebSocket behavior
- InsightsTabs and InsightsPanel components (consumers, not owners of state)
- API endpoints: GET/POST /api/videos/[id]/insights
- Cancel functionality during extraction

## Hardest Constraint
The useExtraction hook currently owns both the state and the WebSocket callback registration. Splitting these apart — state in context, callbacks still wired through AgentConnection — requires careful lifecycle management so callbacks don't leak or orphan.

## Technical Concerns
- Race condition: user starts extraction, navigates away, extraction completes and writes to DB, user returns — need to check DB first before assuming store state is current
- Memory: partial JSON blobs in the store for each active extraction; need eviction after DB persistence
- Multiple extractions: if user kicks off extraction on video A then video B, both should track independently

## Recommendations
```

## Recent Checkpoints
```
9fc9f24 checkpoint: chunk 1 complete — ExtractionProvider with global store
a7ca6f5 checkpoint: before chunk 1 — ExtractionProvider global store
7171e05 add focus area badges and quick-assign to video cards
c9a7e38 fix 3 bugs found in QA pass
8eff8db complete experience cycle — story 4 chunks 5-6, lint fixes
24172b7 checkpoint: before chunk 5 — MCP tools & persona suggestion banner
0fcb807 checkpoint: before chunk 4 — panel UI, question detection & persona columns
f2ed23b checkpoint: before chunk 3 — ensemble query, multi-persona streaming & who's best
1698f96 checkpoint: before chunk 2 — single persona query & streaming API
9d5d2b2 checkpoint: before chunk 1 — personas schema, service & CRUD API
```
