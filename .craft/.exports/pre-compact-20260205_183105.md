# Craft State Export (Pre-Compact)

This file was created automatically before context compaction.
Use this to restore state if needed.

## Global State
```bash
LAST_ACTIVITY="2026-02-06T00:28:10Z"
ACTIVE_CYCLE="rag-foundation"
CURRENT_STORY="1-database-migration"
DEFAULT_MODE="creative"
BACKLOG_COUNT=1
HARNESS_CHECKED="2026-02-03"
HARNESS_VERSION="1.0"
CRAFT_WRITE_ENABLED="true"
PLANNING_CYCLE=""
RUN_MODE="cruise"
```

## Cycle State: rag-foundation
```bash
CYCLE_NAME="rag-foundation"
CYCLE_STATUS="active"
CURRENT_STORY="1-database-migration"
CURRENT_CHUNK="5"
TOTAL_CHUNKS="5"
LAST_VALIDATION="2026-02-05T23:40:32Z"
LAST_CHECKPOINT="2026-02-06T00:28:10Z"
TOUCHED_FILES="/Users/darindrobinski/dev/repos/gold-miner/docker-compose.yml /Users/darindrobinski/dev/repos/gold-miner/.env.example /Users/darindrobinski/dev/repos/gold-miner/scripts/init-db.sql /Users/darindrobinski/dev/repos/gold-miner/.gitignore /Users/darindrobinski/dev/repos/gold-miner/README.md /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/__tests__/search.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/schema.ts /Users/darindrobinski/dev/repos/gold-miner/drizzle.config.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/index.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/search.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/route.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/insights.ts /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/__tests__/insights.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/scripts/migrate-data.ts /Users/darindrobinski/dev/repos/gold-miner/package.json /Users/darindrobinski/dev/repos/gold-miner/src/lib/db/__tests__/setup.ts /Users/darindrobinski/dev/repos/gold-miner/vitest.config.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts /Users/darindrobinski/dev/repos/gold-miner/src/app/api/videos/[id]/insights/__tests__/route.test.ts"
```

## Current Story
File: .craft/cycles/rag-foundation/stories/1-database-migration.md

```markdown
---
name: database-migration
title: Database Migration
status: active
priority: high
created: 2026-02-05
updated: 2026-02-05
cycle: rag-foundation
story_number: 1
chunks_total: 5
chunks_complete: 4
---

# Story: Database Migration

## Spark

Replace SQLite with Postgres + PG Vector extension. This is the foundation for all RAG capabilities â€” without vector storage, no embeddings, no semantic search.

Keep Drizzle ORM (Brad confirmed it's fine). Design the schema to be Neon-compatible from day one (connection pooling, SSL, etc.) even though we're running locally for now.

Migrate existing data (videos, insights, channels) to the new Postgres instance. Add new columns/tables for embeddings that will be populated by Story 3.

> *"Store it in Postgres. You have to do embeddings. You have to do rags. Do it local for now, but then we can deploy it to Vercel with the Neon database."*

## Dependencies

**Blocked by:** None (first story)
**Blocks:** Story 3 (Embedding Pipeline), Story 4 (RAG Search)

## Acceptance

- [ ] Docker Compose starts Postgres with pgvector extension
- [ ] Drizzle schema uses Postgres types (pgTable, serial, timestamp, jsonb)
- [ ] New `chunks` table exists with vector column (384 dimensions for FastEmbed)
- [ ] Database connection works with connection pooling
- [ ] Simple ILIKE search replaces FTS5 (temporary until vector search)
- [ ] All existing SQLite data migrated to Postgres
- [ ] All API routes work with async Postgres queries
- [ ] All tests pass with Postgres
- [ ] No SQLite dependencies remain in codebase
- [ ] Neon-compatible (SSL handling, connection string format)

## Chunks

### Chunk 1: Docker Setup + Postgres with pgvector

**Goal:** Local Postgres database with pgvector extension running in Docker.

**Files:**
```

## Recent Checkpoints
```
78caa82 checkpoint: before story 1, chunk 5
1efd087 checkpoint: before story 1, chunk 4
4ebc576 checkpoint: before story 1, chunk 2
dc400ff checkpoint: before story 1, chunk 1
2637e79 checkpoint: before story 6, chunk 1
359a9fa checkpoint: before story 4, chunk 1
fb16f99 story 3, chunk 5: video detail page
c9536e1 checkpoint: before story 3, chunk 5
eec7588 story 3, chunk 4: transcript parser utility
908092f checkpoint: before story 3, chunk 4
```
